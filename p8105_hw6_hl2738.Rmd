---
title: "P8105 Homework 6"
author: Heidi Lumish
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(car)
library(modelr)
library(patchwork)

set.seed(1)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1: Birthweights

#### Import and clean the data

First we will convert all categorical variables to factor variables.

```{r}
birthweight = read_csv("./data/birthweight.csv") %>%
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace)
  )
```

We can check for missing values using the following code, and we see that there are no missing values:

```{r}
colSums(is.na(birthweight))

```

str(birthweight)

Descriptive statistics

```{r}
multiple_func <- function(x) {
  
    if (is.numeric(x)) {

    min = min(x)
    max = max(x)
    mean = mean(x)
    sd = sd(x)
    
    output_df = 
    tibble(
      min = min,
      max = max,
      mean = mean,
      sd = sd)

  return(output_df)
   
    }     
}

sapply(birthweight, multiple_func)

```

Menarche should not be 0

```{r}
birthweight %>% 
  filter(menarche == 0)
```

#### Build a regression model
Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.

Hypothesis: Maternal factors affect infant's birthweight

Variables to test:
- Mother's pre-pregnancy BMI (ppbmi)
- Mother's race (mrace)
- Mother's weight at delivery (delwt)
- Mother's age at delivery (momage)
- Mother's age at menarche (menarche)
- Cigarette smoking during pregnancy (smoken).

Plots
```{r}
scatterplotMatrix(~bwt + ppbmi + delwt + momage + menarche + smoken, data = birthweight)

birthweight %>% 
  ggplot(aes(x = mrace, y = bwt)) + 
  geom_boxplot()
```

Fitting the linear model
```{r}
maternal_model = lm(bwt ~ ppbmi + mrace + delwt + momage + menarche + smoken, data = birthweight)

maternal_model %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

Show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.

```{r}
birthweight %>% 
  add_residuals(maternal_model) %>% 
  add_predictions(maternal_model) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point()
```

#### Compare to two other models

##### Length and gestational age

Scatterplots
```{r}
blength_plot = birthweight %>% 
  ggplot(aes(x = blength, y = bwt)) + 
  geom_point()

gaweeks_plot = birthweight %>% 
  ggplot(aes(x = gaweeks, y = bwt)) + 
  geom_point()

blength_plot + gaweeks_plot
```

```{r}
length_age_model = lm(bwt ~ blength + gaweeks, data = birthweight)

length_age_model %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

##### Interaction model

```{r}
interaction_model = lm(bwt ~ bhead + blength + babysex +
                         bhead * blength + bhead * babysex + blength * babysex,
                       data = birthweight)

interaction_model %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

#### Cross validation

Now we will cross-validation to compare the models

```{r}
cv_df = 
  crossv_mc(birthweight, 10) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )

cv_df = cv_df %>% 
  mutate(
    maternal_mod = map(.x = train, ~lm(bwt ~ ppbmi + mrace + delwt + momage + menarche + smoken, data = .x)),
    length_age_mod = map(.x = train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    interaction_mod = map(.x = train, ~lm(bwt ~ bhead + blength + babysex +
                         bhead * blength + bhead * babysex + blength * babysex, data = .x))
  ) %>%
  mutate(
    rmse_maternal = map2_dbl(.x = maternal_mod, .y = test, ~rmse(model = .x, data = .y)),
    rmse_length_age = map2_dbl(.x = length_age_mod, .y = test, ~rmse(model = .x, data = .y)),
    rmse_interaction = map2_dbl(.x = interaction_mod, .y = test, ~rmse(model = .x, data = .y))
  )
```

Look at the output
Ideally using a boxplot

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    rmse_maternal:rmse_interaction,
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse)) +
  geom_boxplot()
```

Boxplots help us understand across 100 testing and training datasets, which one had the lowest rmse.


## Problem 2: Central Park Weather Data

#### Download the data

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = "CentralPark_NY",
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

We’ll focus on a simple linear regression with tmax as the response and tmin as the predictor, and are interested in the distribution of two quantities estimated from these data:

Use 5000 bootstrap samples and, for each bootstrap sample, produce estimates of these two quantities. Plot the distribution of your estimates, and describe these in words. Using the 5000 bootstrap estimates, identify the 2.5% and 97.5% quantiles to provide a 95% confidence interval for r̂ 2 and log(β̂ 0∗β̂ 1). Note: broom::glance() is helpful for extracting r̂ 2 from a fitted regression, and broom::tidy() (with some additional wrangling) should help in computing log(β̂ 0∗β̂ 1).

```{r}
bootstrap_weather =
  weather_df %>% 
  sample_frac(size = 1, replace = TRUE) %>% 
  arrange(tmin)

lm(tmax ~ tmin, data = bootstrap_weather)
```

Now we will generate 5000 bootstrap samples.

```{r}
bootstrap_weather_df =
  weather_df %>% 
  bootstrap(n = 5000, id = "strap_number")
```

Next we will run the linear model on the 5000 bootstrap samples to generate the estimates.

```{r}
bootstrap_results =
  bootstrap_weather_df %>% 
  mutate(
    models = map(.x = strap, ~lm(tmax ~ tmin, data = .x)),
    results = map(models, broom::tidy),
    results2 = map(models, broom::glance)
  ) %>% 
  select(strap_number, results, results2) %>% 
  unnest(results2) %>% 
  select(strap_number, results, r.squared) %>%
  unnest(results) %>% 
  select(strap_number, term, estimate, r.squared) %>%
  pivot_wider(
    names_from = "term",
    values_from = "estimate"
  ) %>% 
  janitor::clean_names() %>% 
  mutate(
    beta0_beta1 = log(intercept * tmin)
  )
```

Plot distribution of the two estimates
We can see that both distributions are normally distributed. The estimates in panel A for log(beta0 * beta1) centers around 2.02 and the estimates in panel B for R-squared center around 0.915.

```{r}
r_squared_histo =
  bootstrap_results %>% 
  ggplot(aes(x = r_squared)) +
  geom_histogram() +
  labs(x = "R-squared",
      y = "Frequency")

beta0_beta1_histo = bootstrap_results %>% 
  ggplot(aes(x = beta0_beta1)) +
  geom_histogram() + 
  labs(x = "log(beta0 * beta1)", 
      y = "Frequency")

estimates = beta0_beta1_histo + r_squared_histo

estimates + plot_annotation(
  title = 'The distribution of estimates over 5000 bootstrap samples',
  tag_levels = 'A'
)
```

Obtain 95% CI

```{r}
bootstrap_results %>% 
  summarize(
    ci_lower_r2 = quantile(r_squared, 0.025), 
    ci_upper_r2 = quantile(r_squared, 0.975),
    ci_lower_b0b1 = quantile(beta0_beta1, 0.025), 
    ci_upper_b0b1 = quantile(beta0_beta1, 0.975),
    ) %>% 
  knitr::kable()
```
