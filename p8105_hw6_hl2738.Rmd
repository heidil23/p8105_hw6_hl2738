---
title: "P8105 Homework 6"
author: Heidi Lumish
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(car)
library(modelr)
library(patchwork)

set.seed(1)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

#### Import and clean the data

First we will convert all categorical variables to factor variables.

```{r}
birthweight = read_csv("./data/birthweight.csv") %>%
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace)
  )
```

We can check for missing values using the following code, and we see that there are no missing values:

```{r}
colSums(is.na(birthweight))

```

str(birthweight)

Descriptive statistics

```{r}
multiple_func <- function(x) {
  
    if (is.numeric(x)) {

    min = min(x)
    max = max(x)
    mean = mean(x)
    sd = sd(x)
    
    output_df = 
    tibble(
      min = min,
      max = max,
      mean = mean,
      sd = sd)

  return(output_df)
   
    }     
}

sapply(birthweight, multiple_func)

```

Menarche should not be 0

```{r}
birthweight %>% 
  filter(menarche == 0)
```

#### Build a regression model
Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.

Hypothesis: Maternal factors affect infant's birthweight

Variables to test:
- Mother's pre-pregnancy BMI (ppbmi)
- Mother's race (mrace)
- Mother's weight at delivery (delwt)
- Mother's age at delivery (momage)
- Mother's age at menarche (menarche)
- Cigarette smoking during pregnancy (smoken).

Plots
```{r}
scatterplotMatrix(~bwt + ppbmi + delwt + momage + menarche + smoken, data = birthweight)

birthweight %>% 
  ggplot(aes(x = mrace, y = bwt)) + 
  geom_boxplot()
```

Fitting the linear model
```{r}
maternal_model = lm(bwt ~ ppbmi + mrace + delwt + momage + menarche + smoken, data = birthweight)

maternal_model %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

Show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.

```{r}
birthweight %>% 
  add_residuals(maternal_model) %>% 
  add_predictions(maternal_model) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point()
```

#### Compare to two other models

##### Length and gestational age

Scatterplots
```{r}
blength_plot = birthweight %>% 
  ggplot(aes(x = blength, y = bwt)) + 
  geom_point()

gaweeks_plot = birthweight %>% 
  ggplot(aes(x = gaweeks, y = bwt)) + 
  geom_point()

blength_plot + gaweeks_plot
```

```{r}
length_age_model = lm(bwt ~ blength + gaweeks, data = birthweight)

length_age_model %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

##### Interaction model

```{r}
interaction_model = lm(bwt ~ bhead + blength + babysex +
                         bhead * blength + bhead * babysex + blength * babysex,
                       data = birthweight)

interaction_model %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

#### Cross validation

Now we will cross-validation to compare the models

```{r}
cv_df = 
  crossv_mc(birthweight, 10) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )

cv_df = cv_df %>% 
  mutate(
    maternal_mod = map(.x = train, ~lm(bwt ~ ppbmi + mrace + delwt + momage + menarche + smoken, data = .x)),
    length_age_mod = map(.x = train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    interaction_mod = map(.x = train, ~lm(bwt ~ bhead + blength + babysex +
                         bhead * blength + bhead * babysex + blength * babysex, data = .x))
  ) %>%
  mutate(
    rmse_maternal = map2_dbl(.x = maternal_mod, .y = test, ~rmse(model = .x, data = .y)),
    rmse_length_age = map2_dbl(.x = length_age_mod, .y = test, ~rmse(model = .x, data = .y)),
    rmse_interaction = map2_dbl(.x = interaction_mod, .y = test, ~rmse(model = .x, data = .y))
  )
```

Look at the output
Ideally using a boxplot

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    rmse_maternal:rmse_interaction,
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse)) +
  geom_boxplot()
```

Boxplots help us understand across 100 testing and training datasets, which one had the lowest rmse.
